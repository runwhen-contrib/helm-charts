{{- if .Values.runner.enabled -}}
apiVersion: v1
kind: ConfigMap
metadata: 
  name: otel-collector
  namespace: {{ .Release.Namespace }}
  labels:
    app: otel-collector
data: 
  relay: |
    extensions:
      health_check:
        endpoint: ${MY_POD_IP}:13133
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
      prometheus:
        config:
          global:
            scrape_interval: 15s 
          scrape_configs:
            - job_name: pushgw
              static_configs:
                - targets: 
                  - pushgateway:9091
            - job_name: opentelemetry-collector
              static_configs:
                - targets:
                    - 0.0.0.0:8888

    exporters:
      prometheusremotewrite:
        endpoint: {{ .Values.runner.metrics.url }}
        {{- if .Values.proxy.enabled }}
        http_client_settings:
          {{- with .Values.proxy.httpsProxy }}
          proxy_url: "{{ . }}"
          {{- end }}
          {{- with .Values.proxy.noProxy }}
          no_proxy: "{{ . }}"
          {{- end }}
        {{- end }}
        tls:
          {{- if .Values.proxyCA }}
          ca_file: "/etc/ssl/certs/proxy-ca.crt"
          {{- else }}
          ca_file: "/tls/ca.crt"
          {{- end }}
          cert_file: "/tls/tls.crt"
          key_file: "/tls/tls.key"
          insecure_skip_verify: true
        external_labels:
            workspace: {{ include "runwhen-local.workspaceName" . }}

    processors:
      batch:
        timeout: 5s
        send_batch_max_size: 10000

    service:
      pipelines:
        metrics:
          receivers: [otlp, prometheus]
          processors: [batch]
          exporters: [prometheusremotewrite]
      extensions:
        - health_check
      telemetry:
        logs:
          level: debug
        metrics:
          address: 0.0.0.0:8888

{{- end }}
